# コアシステム仕様: オーバーレイ同期と背景モード

## 1. オーバーレイ同期システム
本システムは、操作を行う「コントローラー窓」と、配信ソフト（OBS等）に表示する「オーバーレイ窓」の間でリアルタイムなデータ同期を行います。

### 同信方式
- **BroadcastChannel API**: `remote_duel_sync` および `remote_duel_sync_yugioh` のチャンネルを使用して、同一ブラウザ内の別タブ・別ウィンドウ間でメッセージを送信します。
- **同期されるデータ**:
    - ゲームモード（Yu-Gi-Oh! / Hololive）
    - 各プレイヤーのライフポイント
    - ダイス・コインの実行結果
    - 背景表示モード（Normal / Green）
    - ビデオ背景設定（ソース・反転・クロップ情報）
    - ビデオ調整モードのON/OFF状態
    - 選択中のカード情報（ホロライブモード時）

### オーバーレイ操作 (OverlayWidget)
- **自由な配置と変形**: オーバーレイウィンドウ上のコンテンツは、マウス操作で自由に移動・拡大縮小・回転が可能です。
- **操作ハンドル**: コンテンツをホバーすると、下部中央に4つの操作ハンドルが表示されます。
    - **全画面 (Fullscreen)**: ブラウザの表示を全画面に切り替え、アドレスバー等を隠します。
    - **移動 (Move)**: ドラッグで画面内の任意の場所に配置。
    - **回転 (Rotate)**: ドラッグで回転。0°, 90°, 180°, 270° に近づくと自動的にスナップ（吸い付き）します。
    - **拡大縮小 (Resize)**: ドラッグで無段階にサイズ変更が可能。
- **レスポンシブな相対配置**:
    - ウィジェットの位置はピクセルではなく、画面幅・高さに対する割合（`vw`, `vh`）で管理されます。
    - **ウィンドウリサイズへの追従**: ウィンドウのサイズを変更しても、ウィジェットは相対的な位置と比率を維持したまま、遅延（ラグ）なくピタッと追従します。
    - **基準サイズ**: 高さ `720px` を基準としたスケーリング係数が適用され、解像度が変わっても視覚的な大きさが一定に保たれます。

### ウィンドウ管理
- **URLパラメータ**: `?mode=overlay` が付与された状態で開かれたウィンドウは「オーバーレイモード」として動作し、UI操作が無効化され、表示に特化した高度な操作UI（OverlayWidget）が有効になります。
- **状態の保存**: 
    - 各ゲームモード（遊戯王/ホロライブ）ごとに、位置・サイズ・回転角の状態が個別に（`v4` キーで）保存されます。
- **ウィンドウタイトルの動的識別**:
    - OBSのウィンドウキャプチャにおいて、コントローラーとオーバーレイを確実に判別するため、モードに応じてタイトルが動的に変更されます。
    - **操作画面**: `Remote Duel Tool`
    - **オーバーレイ画面**: `Remote Duel Overlay`

## 2. 背景表示モード (OBS統合)
配信ソフトへの取り込みを最適化するため、以下の2つのモードを切り替え可能です。

- **通常 (Normal)**: アプリ標準のダーク背景を表示。
- **グリーンバック (Green)**: 背景を `#00ff00` に設定。クロマキー合成を想定したモード。
- **ビデオ背景 (Video)**: カメラ映像または画面共有映像を最背面に表示。

### ビデオ調整システム (Video Adjustment)
オーバーレイ窓に表示されるビデオ映像は、コントローラー窓からリモートで調整可能です。調整モード中は、誤操作を防ぎ、視認性を高めるための専用UIが表示されます。

- **調整モードの起動**: コントローラーの「ビデオ調整」ボタン、またはキーボードの `A` キー、あるいはオーバーレイ窓上での **マウスホイールクリック** で切り替えます。
- **視覚的なフィードバック (Adjustment UI)**:
    - **レッド・ワーニングテーマ**: 調整モード中は、画面全体が **8pxの太い赤い枠（ガイド）** で囲まれ、上部には赤い境界線のバナーが表示されます。
    - **ステータス表示**: バナー左側に赤い点滅インジケーターと「ビデオ調整中」の赤い文字が表示され、現在の状態を明示します。
- **映像の操作**:
    - **移動 (Pan)**: 映像をドラッグして、表示位置を自由に調整できます。
    - **ズーム (Zoom)**: マウスホイールの回転で映像を拡大・縮小（1.0倍〜5.0倍）できます。
- **変形コントロール (Rotation & Flip)**:
    - **回転**: 左90°、右90°、180°の回転が可能です。
    - **反転**: 左右（水平）反転、上下（垂直）反転が可能です。
    - **動的Swap機能**: 回転や反転を行った際、現在のトリミング範囲を維持するため、内部的に上下左右のトリミング値が自動的にスワップ（入れ替え）されます。
- **トリミング (Trimming)**:
    - **空間的一貫性 (Spatial Mapping)**: 映像がどのような回転・反転状態にあっても、スライダーの「上端」を操作すれば常に画面上の見た目通りの「上端」が削られます。これは、CSSの変形順序（回転→反転）の逆変換を計算することで実現されています。
- **直感的なアイコン**: 回転・反転操作には、機能がひと目でわかる専用のインダストリアルデザインのSVGアイコンが採用されています。

## 3. データの永続化
以下のデータは `localStorage` に保存され、ブラウザのリロードや再起動後も保持されます。
- `remote_duel_obs_mode`: 背景モード
- `hololive_search_filters`: ホロライブの検索条件
- `hololive_pinned_cards`: ピン留めされたカードデータ
- `hololive_selected_card`: 最後に選択したカード
- `yugioh_p1_state` / `yugioh_p2_state`: 遊戯王のライフ・ログ
- `overlay_widget_v4_yugioh`: 遊戯王オーバーレイの配置状態（位置・縮尺・回転）
- `overlay_widget_v4_hololive`: ホロライブオーバーレイの配置状態（位置・縮尺・回転）
- `remote_duel_video_source`: ビデオソース選択（none / camera / screen）
- `remote_duel_video_crop`: ビデオの位置・ズーム・回転・反転・トリミング情報（JSON形式）

## 4. キャッシュ制御
アプリケーションの更新を確実に反映させるため、以下の仕組みを導入しています。
- **配信最適化 (No-Cache)**: `index.html` の Meta タグに Cache-Control (`no-cache, no-store, must-revalidate`) を有効化。
- **仕組み**: ブラウザがアクセスするたびにサーバーへ最新の `index.html`（指示書）を確認するようにし、JS や CSS ファイル名のハッシュ値が変更された際、確実に最新のコードを読み込ませる仕組みです。この設定はアプリケーションのデータ（設定値）の保存には影響しません。
