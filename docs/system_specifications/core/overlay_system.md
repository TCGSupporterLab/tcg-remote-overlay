# コアシステム仕様: オーバーレイ同期と背景モード

## 1. オーバーレイ同期システム
本システムは、操作を行う「コントローラー窓」と、配信ソフト（OBS等）に表示する「オーバーレイ窓」の間でリアルタイムなデータ同期を行います。

### 同信方式
- **BroadcastChannel API**: `remote_duel_sync` および `remote_duel_sync_yugioh` のチャンネルを使用して、同一ブラウザ内の別タブ・別ウィンドウ間でメッセージを送信します。
- **同期されるデータ**:
    - ゲームモード（Yu-Gi-Oh! / Hololive）
    - 各プレイヤーのライフポイント
    - ダイス・コインの実行結果
    - 背景表示モード（Normal / Green）
    - 選択中のカード情報（ホロライブモード時）

### オーバーレイ操作 (OverlayWidget)
- **自由な配置と変形**: オーバーレイウィンドウ上のコンテンツは、マウス操作で自由に移動・拡大縮小・回転が可能です。
- **操作ハンドル**: コンテンツをホバーすると、下部中央に4つの操作ハンドルが表示されます。
    - **全画面 (Fullscreen)**: ブラウザの表示を全画面に切り替え、アドレスバー等を隠します。
    - **移動 (Move)**: ドラッグで画面内の任意の場所に配置。
    - **回転 (Rotate)**: ドラッグで回転。0°, 90°, 180°, 270° に近づくと自動的にスナップ（吸い付き）します。
    - **拡大縮小 (Resize)**: ドラッグで無段階にサイズ変更が可能。
- **レスポンシブな相対配置**:
    - ウィジェットの位置はピクセルではなく、画面幅・高さに対する割合（`vw`, `vh`）で管理されます。
    - **ウィンドウリサイズへの追従**: ウィンドウのサイズを変更しても、ウィジェットは相対的な位置と比率を維持したまま、遅延（ラグ）なくピタッと追従します。
    - **基準サイズ**: 高さ `720px` を基準としたスケーリング係数が適用され、解像度が変わっても視覚的な大きさが一定に保たれます。

### ウィンドウ管理
- **URLパラメータ**: `?mode=overlay` が付与された状態で開かれたウィンドウは「オーバーレイモード」として動作し、UI操作が無効化され、表示に特化した高度な操作UI（OverlayWidget）が有効になります。
- **状態の保存**: 
    - 各ゲームモード（遊戯王/ホロライブ）ごとに、位置・サイズ・回転角の状態が個別に（`v4` キーで）保存されます。
- **ウィンドウタイトルの動的識別**:
    - OBSのウィンドウキャプチャにおいて、コントローラーとオーバーレイを確実に判別するため、モードに応じてタイトルが動的に変更されます。
    - **操作画面**: `Remote Duel Tool`
    - **オーバーレイ画面**: `Remote Duel Overlay`

## 2. 背景表示モード (OBS統合)
配信ソフトへの取り込みを最適化するため、以下の2つのモードを切り替え可能です。

- **通常 (Normal)**: アプリ標準のダーク背景を表示。
- **グリーンバック (Green)**: 背景を `#00ff00` に設定。クロマキー合成を想定したモード。

## 3. データの永続化
以下のデータは `localStorage` に保存され、ブラウザのリロードや再起動後も保持されます。
- `remote_duel_obs_mode`: 背景モード
- `hololive_search_filters`: ホロライブの検索条件
- `hololive_pinned_cards`: ピン留めされたカードデータ
- `hololive_selected_card`: 最後に選択したカード
- `yugioh_p1_state` / `yugioh_p2_state`: 遊戯王のライフ・ログ
- `overlay_widget_v4_yugioh`: 遊戯王オーバーレイの配置状態（位置・縮尺・回転）
- `overlay_widget_v4_hololive`: ホロライブオーバーレイの配置状態（位置・縮尺・回転）

## 4. キャッシュ制御
アプリケーションの更新を確実に反映させるため、以下の仕組みを導入しています。
- **配信最適化 (No-Cache)**: `index.html` の Meta タグに Cache-Control (`no-cache, no-store, must-revalidate`) を有効化。
- **仕組み**: ブラウザがアクセスするたびにサーバーへ最新の `index.html`（指示書）を確認するようにし、JS や CSS ファイル名のハッシュ値が変更された際、確実に最新のコードを読み込ませる仕組みです。この設定はアプリケーションのデータ（設定値）の保存には影響しません。
