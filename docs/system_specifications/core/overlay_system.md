# コアシステム仕様: オーバーレイ同期と背景モード

## 1. オーバーレイ同期システム
本システムは、操作を行う「コントローラー窓」と、配信ソフト（OBS等）に表示する「オーバーレイ窓」の間でリアルタイムなデータ同期を行います。

### 同信方式
- **BroadcastChannel API**: 以下の複数の目的別チャンネルを使用して、同一ブラウザ内の別タブ・別ウィンドウ間でメッセージを送信します。
    - `tcg_remote_sync`: ウィジェットのグループ化（Grouping）情報の同期
    - `tcg_remote_search_sync`: カード検索状態、ピン留め、パス階層、表示番号の同期
    - `tcg_remote_sync_lp`: ライフポイント（P1/P2/ターゲット/入力中数値）の同期
    - `tcg_remote_widget_settings`: 全ウィジェット（ダイス、コイン、LP、カード）の表示ON/OFF、初期ライフ設定の同期
    - `tcg_remote_sp_marker_sync`: SPマーカーの状態（表示ON/OFF、表裏面、強制非表示）の同期
- **同期されるデータ**:
    - 各ウィジェットの表示・非表示
    - ライフポイント、ログ、入力中の計算数値
    - 検索フィルタ、ピン留めカードリスト、現在のパス
    - 選択中のカード、表示番号（Shift+数字キーによる操作）
    - ビデオ背景設定（ソース・ズーム・回転・反転・トリミング）
    - ウィンドウ・マネージャー（単一インスタンス管理）

### オーバーレイ操作 (OverlayWidget)
- **自由な配置と変形**: オーバーレイウィンドウ上のコンテンツは、マウス操作で自由に移動・拡大縮小・回転が可能です。
- **操作ハンドル**: コンテンツを選択・ホバーすると、`Moveable` による変形用ガイドと操作ハンドルが表示されます。
    - **移動 (Move) / 回転 (Rotate) / 拡大縮小 (Resize)**: 専用のハンドルを使用して直感的に操作可能。
    - **スナップ機能**: 回転角が 0°, 90°, 180°, 270° に近づくと自動的に吸い付きます。
- **選択アクションバー (SelectionActionBar)**:
    - 複数選択時にのみ表示されるフローティングツールバーです。
    - **グループ化/解除**: 選択したウィジェットを瞬時にグループ化、または解除できます。
- **インテリジェント・ポジショニング**:
    - **動的配置**: アクションバーはウィジェットの回転角を考慮し、操作ハンドル（回転棒）と重ならないよう、自動的にウィジェットの「内側（上端または下端）」に配置されます。
    - **画面端ガード**: ウィンドウサイズが小さい場合やウィジェットが画面端にある場合でも、アクションバーは画面外に突き抜けず、表示可能な範囲に自動的に押し戻（クランプ）されます。
    - **トランスフォーム中の保護**: 移動や回転などの操作中は、視覚的なノイズを減らすためアクションバーは自動的に非表示になります。
- **スマート・ハンドル (Smart Handles)**:
    - **正対維持 (Anti-Rotation)**: `Moveable` の各ハンドルは、ウィジェットの回転に関わらず常に操作しやすい向きを維持します。
    - **画面端吸着**: ウィジェットを画面外に追い出しても、ハンドルやアクションバーは画面内に留まり、常に操作性を確保します。
- **レスポンシブ・スケーリング**:
    - **16:9 ターゲットスループット**: 幅 `1920px` / 高さ `1080px` を基準解像度として管理されます。
    - **ウィンドウリサイズへの追従**: ウィンドウサイズを変更すると、現在の解像度に合わせてウィジェットの大きさが自動的に拡大・縮小されます。これにより、作成時と異なるアスペクト比や解像度の環境でも、意図した通りの比率で表示されます。
    - **座標の相対管理**: 位置は画面幅・高さに対する割合（`px`, `py`）で保存され、リサイズ後も相対的な配置が維持されます。

### ウィンドウ管理と単一インスタンスの強制
- **単一インスタンスの保証**: 
    - `BroadcastChannel` (`tcg_instance_sync`) を使用し、同一タイプの画面（メイン画面またはカード表示設定画面）が新しく開かれた場合、古い方のインスタンスへ終了命令を送信します。
    - **自動終了**: 新規起動を検知した古いウィンドウは `window.close()` を実行します。ブラウザにより終了が拒否された場合は、画面全体に「セッション終了」の警告オーバーレイを表示し、操作を無効化します。
- **URLパラメータによる役割変更**:
    - `?view=search`: **カード表示設定画面**（フルスクリーン検索UI）として動作。
    - `?mode=overlay`: **オーバーレイ画面**（表示専用の高度な操作UI）として動作。
- **ウィンドウタイトルの動的識別**:
    - OBSでのキャプチャや識別を容易にするため、表示内容に応じてタイトルが動的に変更されます。
    - **メイン画面**: `TCG Remote Overlay`
    - **カード表示設定画面**: `TCG Remote Overlay - カード表示設定`

## 2. 背景表示モード (OBS統合)
配信ソフトへの取り込みを最適化するため、以下の2つのモードを切り替え可能です。

- **通常 (Normal)**: アプリ標準のダーク背景を表示。
- **グリーンバック (Green)**: 背景を `#00ff00` に設定。クロマキー合成を想定したモード。
- **ビデオ背景 (Video)**: カメラ映像または画面共有映像を最背面に表示。

### ビデオ調整システム (Video Adjustment)
オーバーレイ窓に表示されるビデオ映像は、コントローラー窓からリモートで調整可能です。調整モード中は、誤操作を防ぎ、視認性を高めるための専用UIが表示されます。

- **調整モードの起動**: コントローラーの「ビデオ調整」ボタン、またはキーボードの `A` キー、あるいはオーバーレイ窓上での **マウスホイールクリック** で切り替えます。
- **視覚的なフィードバック (Adjustment UI)**:
    - **レッド・ワーニングテーマ**: 調整モード中は、画面全体が **10pxの太い赤い枠（ガイド）** で囲まれ、上部には赤い境界線のバナーが表示されます。
    - **ステータス表示**: バナー左側に赤い点滅インジケーターと「ビデオ調整中」の明るい赤い文字（`#ff0000`）が表示され、現在の状態を強く警告します。
- **バナーアクション (Banner Actions)**:
    - **全画面 (Fullscreen)**: バナー右端のボタンから、オーバーレイ窓を全画面表示に切り替えられます。
    - **リセット (Reset)**: ビデオの変形・トリミング状態を初期化します。
    - **完了 (Complete)**: 調整モードを終了します。ボタンは一貫したデザイン（白背景・青文字）で統一されています。
- **映像の操作**:
    - **移動 (Pan)**: 映像をドラッグして、表示位置を自由に調整できます。
    - **ズーム (Zoom)**: マウスホイールの回転で映像を拡大・縮小（1.0倍〜5.0倍）できます。
- **変形コントロール (Rotation & Flip)**:
    - **回転**: 左90°、右90°、180°の回転が可能です。
    - **反転**: 左右（水平）反転、上下（垂直）反転が可能です。
    - **動的Swap機能**: 回転や反転を行った際、現在のトリミング範囲を維持するため、内部的に上下左右のトリミング値が自動的にスワップ（入れ替え）されます。
- **トリミング (Trimming)**:
    - **空間的一貫性 (Spatial Mapping)**: 映像がどのような回転・反転状態にあっても、スライダーの「上端」を操作すれば常に画面上の見た目通りの「上端」が削られます。これは、CSSの変形順序（回転→反転）の逆変換を計算することで実現されています。
- **直感的なアイコン**: 回転・反転操作には、機能がひと目でわかる専用のインダストリアルデザインのSVGアイコンが採用されています。

## 3. データの永続化
本システムでは `localStorage` および `IndexedDB` (idb-keyval) を併用してデータを保存します。

### localStorage 保存項目
- `tcg_remote_obs_mode`: 背景モード（通常/GB/Video）
- `tcg_remote_video_source`: ビデオソース
- `tcg_remote_video_crop`: ビデオ調整詳細（ズーム、回転、トリミング等）
- `tcg_remote_widget_settings_v4`: **ウィジェット表示設定**（ダイス、コイン、LP、カード表示のON/OFF、初期LP設定、Player1のみ表示等）
- `tcg_remote_sp_marker_state_v4`: **SPマーカーの状態**（表示ON/OFF、表面/裏面状態）
- `overlay_widget_v4_***`: 各ウィジェット（lp_calculator, card_widget等の配置座標、スケール、回転角（`-180`〜`180`度に正規化保存）
- `widget_groups`: ウィジェットのグループ化構成情報

### IndexedDB (idb-keyval) 保存項目
カードデータ等の容量が大きなデータや、フォルダごとの状態管理に使用されます。
- `tcg_remote_pinned_cards_v2`: ピン留めされた全カードデータリスト
- `tcg_remote_current_path_v2`: 最後に開いていたフォルダの階層パス
- `tcg_remote_selected_card_v2`: 最後に選択（クリック）したカード情報
- `tcg_remote_display_card_no_v2`: カードウィジェットに現在表示中の番号
- `tcg_remote_folder_cache_v1`: フォルダごとに独立した「ピン留め」「選択中カード」「現在地」のキャッシュ（最大5件）

※ **`isForceHidden`** (Oキーによる一時的な非表示) は、利便性と予期せぬトラブル防止（再起動時に消えたままになるのを防ぐ）のため、永続化対象から除外されています。

## 4. キャッシュ制御
アプリケーションの更新を確実に反映させるため、以下の仕組みを導入しています。
- **配信最適化 (No-Cache)**: `index.html` の Meta タグに Cache-Control (`no-cache, no-store, must-revalidate`) を有効化。
- **仕組み**: ブラウザがアクセスするたびにサーバーへ最新の `index.html`（指示書）を確認するようにし、JS や CSS ファイル名のハッシュ値が変更された際、確実に最新のコードを読み込ませる仕組みです。この設定はアプリケーションのデータ（設定値）の保存には影響しません。
