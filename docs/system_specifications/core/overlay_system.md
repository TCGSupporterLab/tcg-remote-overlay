# コアシステム仕様: オーバーレイ同期と背景モード

## 1. オーバーレイ同期システム
本システムは、操作を行う「コントローラー窓」と、配信ソフト（OBS等）に表示する「オーバーレイ窓」の間でリアルタイムなデータ同期を行います。

### 同信方式
- **BroadcastChannel API**: 以下の複数の目的別チャンネルを使用して、同一ブラウザ内の別タブ・別ウィンドウ間でメッセージを送信します。
    - `tcg_remote_sync`: ウィジェットのグループ化（Grouping）情報の同期
    - `tcg_remote_search_sync`: カード検索状態、ピン留め、パス階層、表示番号の同期
    - `tcg_remote_sync_lp`: ライフポイント（P1/P2/ターゲット/入力中数値）の同期
    - `tcg_remote_widget_settings`: 全ウィジェット（ダイス、コイン、LP、カード）の表示ON/OFF、初期ライフ設定の同期
    - `tcg_remote_sp_marker_sync`: SPマーカーの状態（表示ON/OFF、表裏面、強制非表示）の同期
- **同期されるデータ**:
    - 各ウィジェットの表示・非表示
    - ライフポイント、ログ、入力中の計算数値
    - 検索フィルタ、ピン留めカードリスト、現在のパス
    - 選択中のカード、表示番号（Shift+数字キーによる操作）
    - 映像背景設定（ソース・ズーム・回転・反転・トリミング）
    - ウィンドウ・マネージャー（単一インスタンス管理）

### オーバーレイ操作 (OverlayWidget)
- **自由な配置と変形**: オーバーレイウィンドウ上のコンテンツは、マウス操作で自由に移動・拡大縮小・回転が可能です。
- **操作ハンドル**: コンテンツを選択・ホバーすると、`Moveable` による変形用ガイドと操作ハンドルが表示されます。
    - **移動 (Move) / 回転 (Rotate) / 拡大縮小 (Resize)**: 専用のハンドルを使用して直感的に操作可能。
    - **スナップ機能**: 回転角が 0°, 90°, 180°, 270° に近づくと自動的に吸い付きます。
- **選択アクションバー (SelectionActionBar)**:
    - 複数選択時にのみ表示されるフローティングツールバーです。
    - **グループ化/解除**: 選択したウィジェットを瞬時にグループ化、または解除できます。
    - **スマート・リセット (Smart Reset)**: 選択中のウィジェットを標準位置・状態に復元します。
        - **単一選択**: 画面中央（0,0）へ移動し、拡大率1.0、回転角0°にリセット。
        - **グループ選択**: グループ化を行った瞬間の「相対的な配置関係」を維持したまま、グループ全体の中心が画面中央に来るように復元します。
        - **複数・混在選択**: 矩形選択などで一時的に複数選ばれている場合、それぞれに対して個別に上記のリセットが適用されます。
- **誤操作防止 (Action Shield & Interaction Exclusion)**:
    - **内部ガード**: ウィジェットが選択状態（Moveableの枠が表示されている状態）の時、ウィジェット内部のボタン（ダイス、計算機等）へのクリックは無視されます。これにより、移動や変形を行おうとして意図せず数値を変更してしまうミスを防止しています。
    - **入力遮断 (Interaction Exclusion)**: 設定メニュー（`.settings-overlay`）、映像調整パネル（`.video-adjustment-overlay`）、および選択アクションバー（`.selection-action-bar`）上での操作は、背後のウィジェットの選択ツール（Selecto）によって無視されます。これにより、メニュー操作中に背後のウィジェットが意図せず選択解除されたり、ドラッグが開始されたりすることを防止しています。
- **インテリジェント・ポジショニング**:
    - **動的配置**: アクションバーはウィジェットの回転角を考慮し、操作ハンドル（回転棒）と重ならないよう、自動的にウィジェットの「内側（上端または下端）」に配置されます。
    - **画面端ガード**: ウィンドウサイズが小さい場合やウィジェットが画面端にある場合でも、アクションバーは画面外に突き抜けず、表示可能な範囲に自動的に押し戻（クランプ）されます。
    - **トランスフォーム中の保護**: 移動や回転などの操作中は、視覚的なノイズを減らすためアクションバーは自動的に非表示になります。
    - **リサイズ同期の最適化**: ウィンドウのリサイズ中もアクションバーは非表示となり、リサイズ完了後にウィジェットの最新の物理位置が確定するのを待ってから、正確な位置へ再表示されます。
- **スマート・ハンドル (Smart Handles)**:
    - **正対維持 (Anti-Rotation)**: `Moveable` の各ハンドルは、ウィジェットの回転に関わらず常に操作しやすい向きを維持します。
    - **画面端吸着**: ウィジェットを画面外に追い出しても、ハンドルやアクションバーは画面内に留まり、常に操作性を確保します。
- **レスポンシブ・スケーリング**:
    - **16:9 ターゲットスループット**: 幅 `1920px` / 高さ `1080px` を基準解像度として管理されます。
    - **ウィンドウリサイズへの追従**: ウィンドウサイズを変更すると、現在の解像度に合わせてウィジェットの大きさが自動的に拡大・縮小されます。これにより、作成時と異なるアスペクト比や解像度の環境でも、意図した通りの比率で表示されます。
    - **座標の相対管理**: 位置は画面幅・高さに対する割合（`px`, `py`）で保存され、リサイズ後も相対的な配置が維持されます。
    - **高精度同期 (Anti-Jump)**: リサイズ直後のブラウザによるレイアウト計算の遅延を考慮し、ウィジェットの物理座標 (`getBoundingClientRect`) と Moveable の選択枠の座標が完全に一致するまで、ミリ秒単位で「歪み」を監視・リトライ（最大10回）する独自の同期アルゴリズムを搭載。これにより、リサイズ完了後にアクションバーが「古い位置」へジャンプして表示される現象を根本的に防止しています。
- **表示優先順位管理 (Z-Index Management)**:
    *   **マスターオーダー設定**: 設定メニューの「優先表示順」セクションで、ウィジェット間の前後関係をドラッグ＆ドロップにより自由に入れ替えられます。
    *   **レイヤー構造**:
        - **標準レイヤー (500〜600)**: リストの上にあるウィジェットほど、大きな `z-index` が割り当てられ、前面に表示されます。
        - **選択レイヤー (1000〜1100)**: 操作のために選択（クリックまたは矩形選択）されたウィジェットは、リストの順位に関わらず一時的に最前面レイヤーへ移動します。
    *   **独立性の維持**: ウィジェットがグループ化（結合）されている場合でも、重なり順はそれぞれ個別の優先度設定に従います。

## 2. マイレイアウト管理 (My Layout)
複雑なウィジェットの配置や重なり順を保存し、瞬時に復元するための管理システムです。

### 構成要素と保存対象
- **ウィジェットの状態**: 各ウィジェットの位置 (`px`, `py`)、拡大率、回転角。
- **グループ構成**: ウィジェット間のグループ化状態。
- **可視性**: どのウィジェットが表示対象か。
- **重なり順**: ウィジェット間の前後関係 (`widgetOrder`)。
- **基準解像度**: レイアウト作成時のウィンドウサイズ。
- **映像調整設定**: ズーム、回転、反転、トリミング等の詳細設定。
- **他を隠す (Hide Others)**: レイアウト適用時に、保存されていない他のウィジェットを自動的に非表示にするフラグ。

### 管理機能
- **保存 (SaveLayoutDialog)**:
    - アクションバー、映像調整メニュー、設定メニューの各エントリポイントから呼び出し可能。
    - **コンテキスト依存の抽出**:
        - **アクションバーから**: 現在選択されているウィジェットのみを保存対象とします。
        - **メニューから**: 非表示のものを含むすべてのウィジェットを保存対象とします。
    - **オプション選択**: 「ウィジェット」「映像調整」「他を隠す」の各要素を保存に含めるか、ユーザーが個別に選択できます。
- **復元 (Apply)**: 
    - 保存された `hideOthers` フラグが有効な場合、適用時に現在の全ウィジェットを一度非表示にしてから、レイアウトに含まれるものだけを再表示します。
- **外部連携**: 各レイアウトを `.json` ファイルとしてエクスポート・インポート可能です。
- **デフォルトレイアウト自動生成**: プリセットテンプレートには `hideOthers: true` が設定されており、適用時に「シーン全体の切り替え」として動作します。

## 3. ウィンドウ管理と単一インスタンスの強制
- **単一インスタンスの保証**: 
    - `BroadcastChannel` (`tcg_instance_sync`) を使用し、同一タイプの画面（メイン画面またはカード表示設定画面）が新しく開かれた場合、古い方のインスタンスへ終了命令を送信します。
    - **自動終了**: 新規起動を検知した古いウィンドウは `window.close()` を実行します。ブラウザにより終了が拒否された場合は、画面全体に「セッション終了」の警告オーバーレイを表示し、操作を無効化します。
- **URLパラメータによる役割変更**:
    - `?view=search`: **カード表示設定画面**（フルスクリーン検索UI）として動作。
    - `?mode=overlay`: **オーバーレイ画面**（表示専用の高度な操作UI）として動作。
- **ウィンドウタイトルの動的識別**:
    - OBSでのキャプチャや識別を容易にするため、表示内容に応じてタイトルが動的に変更されます。
    - **メイン画面**: `TCG Remote Overlay`
    - **カード表示設定画面**: `TCG Remote Overlay - カード表示設定`

### 設定メニュー (Settings Menu)
- **レイヤー優先順位 (Z-Index: 3000)**:
    - 設定メニューは、アクションバー (`1000`) やスキャンオーバーレイ (`2000`) よりも前面に表示されるよう、高い `z-index` が割り当てられています。
- **直感的な操作**:
    - **背景クリックでの終了**: メニューの枠外（半透明の背景部分）をクリックすることで、メニューを閉じることができます。
    - **キーボード対応**: `Esc` キーによる即時終了をサポートしています。
- **効率的なタブ構成**:
    - 設定項目は以下の順序でタブ分けされており、アイコンによる視覚的な識別とアクセントカラーが付与されています：
        1. **ウィジェット**: 各ゲーム専用ツールの個別設定（デフォルトタブ）。
        2. **背景・映像**: 映像ソースの選択、映像調整、およびOBS用の背景色設定。
        3. **マイレイアウト**: 保存済みレイアウトの適用と管理。
        4. **操作説明**: キーボードショートカット等のガイド。
        5. **About**: バージョン情報と免責事項。
- **カテゴリ・アコーディオン**:
    - 「ウィジェット」タブ内の項目は「汎用ウィジェット」「専用ウィジェット」「共通設定」の3つのカテゴリに分類されています。
    - 各カテゴリは見出しをクリックすることで開閉可能（アコーディオン形式）で、各セクション内にもさらに深い階層のアコーディオン（カード設定、遊戯王設定など）が存在します。
    - **開閉状態の永続化**: すべてのカテゴリおよびセクションの開閉状態は `localStorage` に保存され、再起動後も個人の好みに合わせたレイアウトが維持されます。

## 2. 背景表示モード (OBS統合)
配信ソフトへの取り込みを最適化するため、以下の2つのモードを切り替え可能です。設定は「背景・映像」タブから行います。

- **透過なし (Normal)**: アプリ標準のダーク背景を表示。
- **グリーンバック (Green)**: 背景を `#00ff00` に設定。クロマキー合成を想定したモード。
- **映像背景 (Video)**: カメラ映像または画面共有映像を最背面に表示。

### 映像調整システム (Video Adjustment)
オーバーレイ窓に表示される映像は、コントローラー窓からリモートで調整可能です。調整モード中は、誤操作を防ぎ、視認性を高めるための専用UIが表示されます。

- **調整モードの起動**: コントローラーの「映像調整」ボタン、またはキーボードの `A` キー、あるいはオーバーレイ窓上での **マウスホイールクリック** で切り替えます。
- **視覚的なフィードバック (Adjustment UI)**:
    - **レッド・ワーニングテーマ**: 調整モード中は、画面全体が **10pxの太い赤い枠（ガイド）** で囲まれ、上部には赤い境界線のバナーが表示されます。
    - **ステータス表示**: バナー左側に赤い点滅インジケーターと「映像調整中」の明るい赤い文字（`#ff0000`）が表示され、現在の状態を強く警告します。
- **バナーアクション (Banner Actions)**:
    - **全画面 (Fullscreen)**: バナー右端のボタンから、オーバーレイ窓を全画面表示に切り替えられます。
    - **リセット (Reset)**: 映像の変形・トリミング状態を初期化します。
    - **調整を保存 (Save)**: 現在の映像調整設定を新しいレイアウトとして保存するためのダイアログを開きます。初期状態で「映像調整」がONになっています。
    - **完了 (Complete)**: 調整モードを終了します。ボタンは一貫したデザイン（白背景・青文字）で統一されています。
    - **操作の独立性**: 映像調整モード中であっても「右クリック」や `Esc` キーで設定メニューへのアクセスが可能です。メニューを閉じても映像調整状態は維持されます。
- **スナップ機能 (Snapping)**: 映像の移動・拡大縮小時に、85%のコンテナ境界へ自動的に吸い付くように設定されています。視覚的なノイズを最小限にするため、ガイド線は非表示、吸い付き動作のみが機能します。
- **自動復帰**: 映像ストリーム（画面共有等）が終了した際、自動的に[画面共有を開始]等のボタンを表示する開始画面に復帰します。開始画面のパネルは調整UIより前面（`z-index: 1000`）に配置されています。
- **中心ドットの非表示**: 映像の中心に表示されていた青い基点ドットを削除し、クリーンな調整画面を実現しました。
- **映像の操作**:
    - **移動 (Pan)**: 映像をドラッグして、表示位置を自由に調整できます。
    - **ズーム (Zoom)**: マウスホイールの回転で映像を拡大・縮小（1.0倍〜5.0倍）できます。
- **変形コントロール (Rotation & Flip)**:
    - **回転**: 左90°、右90°、180°の回転が可能です。
    - **反転**: 左右（水平）反転、上下（垂直）反転が可能です。
    - **動的Swap機能**: 回転や反転を行った際、現在のトリミング範囲を維持するため、内部的に上下左右のトリミング値が自動的にスワップ（入れ替え）されます。
- **トリミング (Trimming)**:
    - **空間的一貫性 (Spatial Mapping)**: 映像がどのような回転・反転状態にあっても、スライダーの「上端」を操作すれば常に画面上の見た目通りの「上端」が削られます。これは、CSSの変形順序（回転→反転）の逆変換を計算することで実現されています。
- **直感的なアイコン**: 回転・反転操作には、機能がひと目でわかる専用のインダストリアルデザインのSVGアイコンが採用されています。

## 3. データの永続化
本システムでは `localStorage` および `IndexedDB` (idb-keyval) を併用してデータを保存します。

### localStorage 保存項目
- `tcg_remote_obs_mode`: 背景モード（通常/GB/Video）
- `tcg_remote_video_source`: 映像ソース
- `tcg_remote_video_crop`: 映像調整詳細（ズーム、回転、トリミング等）
- `tcg_remote_widget_store_v3`: **ウィジェットの総合状態**
    - `widgetStates`: 各ウィジェットの配置座標、スケール、回転角
    - `visibility`: 各ウィジェットの表示・非表示（ダイス、コイン、LP、カード等）
    - `settings`: 初期ライフ数値、Player1のみ表示等の詳細設定
    - `widgetOrder`: ウィジェット全体の表示優先順序（マスターリスト）
- `tcg_remote_sp_marker_state_v4`: **SPマーカーの状態**（表示ON/OFF、表面/裏面状態）
- `settings_is***Open`: **設定メニューの開閉状態保持**
    - `settings_isGenericCategoryOpen` / `Specialized` / `Common`: 大カテゴリの開閉。
    - `settings_isCardSectionOpen` / `Yugioh` / `Hololive` / `LP` / `Order`: 各詳細項目の開閉。
- `widget_groups`: ウィジェットのグループ化構成情報
    - **データ構造**:
        - `groups`: グループID、メンバーリスト、アンカー情報、および**結合時の初期状態（Center座標、全メンバーの座標・変形値）**を保持し、精度の高いリセットを実現します。
        - `relativeTransforms`: アンカーウィジェットに対する各メンバーの相対的な距離・角度。

### IndexedDB (idb-keyval) 保存項目
カードデータ等の容量が大きなデータや、フォルダごとの状態管理に使用されます。
- `tcg_remote_pinned_cards_v2`: ピン留めされた全カードデータリスト
- `tcg_remote_current_path_v2`: 最後に開いていたフォルダの階層パス
- `tcg_remote_selected_card_v2`: 最後に選択（クリック）したカード情報
- `tcg_remote_display_card_no_v2`: カードウィジェットに現在表示中の番号
- `tcg_remote_folder_cache_v1`: フォルダごとに独立した「ピン留め」「選択中カード」「現在地」のキャッシュ（最大5件）

※ **`isForceHidden`** (Oキーによる一時的な非表示) は、利便性と予期せぬトラブル防止（再起動時に消えたままになるのを防ぐ）のため、永続化対象から除外されています。

## 4. キャッシュ制御
アプリケーションの更新を確実に反映させるため、以下の仕組みを導入しています。
- **配信最適化 (No-Cache)**: `index.html` の Meta タグに Cache-Control (`no-cache, no-store, must-revalidate`) を有効化。
- **仕組み**: ブラウザがアクセスするたびにサーバーへ最新の `index.html`（指示書）を確認するようにし、JS や CSS ファイル名のハッシュ値が変更された際、確実に最新のコードを読み込ませる仕組みです。この設定はアプリケーションのデータ（設定値）の保存には影響しません。
