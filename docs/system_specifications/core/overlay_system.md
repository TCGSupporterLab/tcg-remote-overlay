# コアシステム仕様: オーバーレイ同期と背景モード

## 1. オーバーレイ同期システム
本システムは、操作を行う「コントローラー窓」と、配信ソフト（OBS等）に表示する「オーバーレイ窓」の間でリアルタイムなデータ同期を行います。

### 同信方式
- **BroadcastChannel API**: `remote_duel_sync` および `remote_duel_sync_yugioh` のチャンネルを使用して、同一ブラウザ内の別タブ・別ウィンドウ間でメッセージを送信します。
- **同期されるデータ**:
    - ゲームモード（Yu-Gi-Oh! / Hololive）
    - 各プレイヤーのライフポイント
    - ダイス・コインの実行結果
    - 背景表示モード（Normal / Transparent / Green）
    - 選択中のカード情報（ホロライブモード時）

### ウィンドウ管理
- **URLパラメータ**: `?mode=overlay` が付与された状態で開かれたウィンドウは「オーバーレイモード」として動作し、UI操作が無効化され、表示に特化したレイアウトに切り替わります。
- **ウィンドウサイズの永続化**: 
    - ユーザーがオーバーレイウィンドウのサイズを変更すると、そのサイズが内部で検知され、コントローラー側に同期・保存されます。
    - ゲームモードごとに最後に使用されたサイズが記憶され、次回起動時に自動的に再現されます。
    - **デフォルトサイズ**: 
        - 遊戯王OCG: 350 x 500 (px)
        - ホロライブOCG: 400 x 700 (px)

## 2. 背景表示モード (OBS統合)
配信ソフトへの取り込みを最適化するため、以下の3つのモードを切り替え可能です。

- **通常 (Normal)**: アプリ標準のダーク背景を表示。
- **透過 (Transparent)**: `body` およびコンテナの背景を透明 (`transparent`) に設定。OBSのブラウザソースで「透過を許可」することで、UIのみを表示可能。
- **グリーンバック (Green)**: 背景を `#00ff00` に設定。クロマキー合成を想定したモード。

## 3. データの永続化
以下のデータは `localStorage` に保存され、ブラウザのリロードや再起動後も保持されます。
- `remote_duel_obs_mode`: 背景モード
- `hololive_search_filters`: ホロライブの検索条件
- `hololive_pinned_cards`: ピン留めされたカードデータ
- `hololive_selected_card`: 最後に選択したカード
- `yugioh_p1_state` / `yugioh_p2_state`: 遊戯王のライフ・ログ・回転状態
- `remote_duel_overlay_size_yugioh`: 遊戯王オーバーレイの保存サイズ
- `remote_duel_overlay_size_hololive`: ホロライブオーバーレイの保存サイズ
