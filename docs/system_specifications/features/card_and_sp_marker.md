# カード検索 & SPマーカーウィジェット仕様 (Card Search & SP Marker Widgets)

## 1. カード検索エンジン

### 除外ロジック
- **エールカード**: 
    - **データ管理**: 公式サイトとの件数照合（スクレイピング時のスキップ判定）のため、`hololive-cards.json` 内には全件保持されます。
    - **UI表示**: アプリケーション（`useCardSearch.ts`）で `cardType` が「エール」のカードは検索結果から常に除外されます。

### キーワード検索
- **正規化 (Normalization)**: 入力テキストは Unicode正規化 (NFKC) を行い、小文字化します。
- **ひらがな対応**: 検索キーワードとカード名の両方を内部的にカタカナに変換して比較することで、「サクラ」と「さくら」の表記ゆれを吸収してヒットさせます。
- **読み仮名 (kana) インデックス**: データ内の `kana` フィールドを検索対象に含めています。
    - これにより、漢字名のカード（例: 「白上フブキ」→「しらかみ」）や、英語名のカード（例: 「Kotori」→「ことり」）をひらがなで検索することが可能です。
- **記号無視照合**: カード名やキーワードに含まれる記号（`・`, `ー`, 空白, `-`, `!`, `?` 等）を除外した状態でも判定を行います。
    - これにより、「じむ」で「ジジ・ムリン」、「ずぶ」で「ローズ・ブラッド...」などの、記号や長音（ー）を挟む検索もヒットするようになります。

### フィルタリング仕様
- **動的フィルタ項目の生成**:
    - **`_meta_filter.json` 連携**: 各フォルダのディレクトリ内に配置された定義ファイルを自動的に読み込み、フィルタのカテゴリー名、選択肢のリスト、および表示順を動的に構築します。
    - **定義の継承と優先順位**:
        - **`metadataOrder`**: `Map<path, Record<key, values[]>>` 形式で全フォルダの定義を保持。
        - **検索時の解決**: 現在の表示パスからルート方向へ遡り、最初に見つかった定義を「有効なフィルタ」として採用します。
        - **データの自動補完**: `folderMetadataMap` により、定義ファイルに記述がないプロパティであっても、ロードされたカードデータから自動的に属性を抽出し、フィルタ項目として追加します。
- **カラーフィルタ (色)**:
    - **単色**: 色文字列が1文字 (`length === 1`)
    - **多色**: 色文字列が2文字以上 (`length >= 2`)
    - **無**: 「◇」記号のみ一致
    - **特定色**: 各色ボタンが押されている場合、`includes` で部分一致判定。
- **タイプフィルタ**:
    - **サポート**: 「サポート」で始まるタイプ（アイテム・イベント等を含む）
    - **LIMITED**: タイプ名に「LIMITED」が含まれるもの
    - **ホロメン / 推しホロメン**: 完全一致
- **Bloomレベルフィルタ**:
    - `Debut`, `1st`, `2nd`, `Spot` の完全一致

## 2. フォルダナビゲーション
- **パンくずリスト**: 現在の階層を視覚的に表示し、クリックで上位ディレクトリへ瞬時に戻ることが可能です。
- **自動遷移の抑制**:
    - ユーザーの利便性のため、フォルダ内に1つしか子要素がない場合は自動的にその中へ遷移します（最大2階層まで）。
    - ユーザーがパンくずリストを手動で操作（ROOTへ戻る等）した場合、自動遷移ロジックは即座に停止し、ユーザーの意図した階層を維持します。この抑制状態は全タブ・ウィンドウ間で同期されます。

## 3. ピン留め機能 (Bookmarks)
- **枚数制限**: 最大 **1,000枚**。
- **個別ピン留め (Variant Support)**: カードIDが同じでも、画像URL（絵柄）が異なるカードは別の個体として個別にピン留め・解除が可能です。
- **並び順**: 追加された順（古い順）に表示されます。
- **並び替え (Reorder)**: 操作画面の「ピン留め」タブ内でドラッグ＆ドロップ操作により自由に位置を変更可能です。
- **番号バッジ**: 操作画面のピン留めカード左上に、並び順に対応した番号（1〜1000）が表示されます。
- **上限到達時**: アラートを表示して追加をブロックします。
- **永続化**: `localStorage` に保存。

## 4. カード表示モード (Card Display Modes)
カードウィジェットは、用途に応じて2つの表示モードを切り替えて使用できます。

- **シンプルモード (Simple Mode)**:
    - **用途**: 任意の画像を即座に表示したい場合。
    - **操作**: ウィジェットに対して画像ファイルをドラッグ＆ドロップすることで、自動的にこのモードに切り替わり画像が表示されます。
    - **永続化**: 選択された画像（Blob URL）はセッション間で維持されます。
- **ライブラリモード (Library Mode)**:
    - **用途**: PC内のカードデータベースを検索して表示したい場合。
    - **操作**: ウィジェットに対してフォルダをドラッグ＆ドロップするか、設定メニューからフォルダを選択することで切り替わります。
    - **フォルダキャッシュと即時同期**: 最後に使用したフォルダ（最大5件）の状態（ピン留め、選択中カード、階層）を個別に記憶しており、フォルダを切り替えるだけで以前の作業状態が復元されます。この状態は全ての画面（本体・検索窓・オーバーレイ）でリアルタイムに保存・共有されます。
        - **新規フォルダの初期化**: 過去のキャッシュが存在しない新しいフォルダを開いた場合は、直前に開いていたフォルダの状態を引き継がず、ピン留めや階層を自動的にリセットした状態で開始されます。

## 5. UIと操作
- **ドラッグ＆ドロップ (Drag & Drop)**:
    - カードウィジェット全体がドロップターゲットとなります。
    - **視覚的フィードバック**: ファイルを重ねると、ドロップ後の挙動（[Simple Mode] または [Library Mode]）を直感的に示す専用のオーバーレイが表示されます。
    - **モード自動遷移**: 画像を落とせばシンプルモードへ、フォルダを落とせばライブラリモードへ、設定を手動で変更することなく瞬時かつシームレスに切り替わります。
- **高速ローディング演出**:
    - データの読み込み中やスキャン中、SVG ネイティブアニメーション (`animateTransform`, `animate`) を活用した、フリーズしない動的なスキャニング画面を表示します。
    - 外周の回転リング、逆回転するレーダー、鼓動する中心コアの3層構造により、システムの稼働状態を直感的に伝えます。
- **無限スクロール**: 50枚ずつの遅延読み込み(`IntersectionObserver`)を採用。
- **キーボードナビゲーション**:
    - `Tab`: 検索タブとピン解除タブの切り替え。
    - `矢印キー (← → ↑ ↓)`: グリッド内のカード選択と自動スクロール。
    - **表示番号の切り替え (Shift + 数字キー)**: どの画面がアクティブであっても、`Shift` を押しながら数字を入力することで、表示対象のカードを即座に切り替えます。
        - **多桁入力対応**: 200ms以内に連続して数字を入力することで、10番目以降（最大1000番まで）のカードを特定可能です。
        - `Shift + 0`: 最後に選択（クリック）したカードを表示します。
        - `Shift + 1〜999`: ピン留めリストの該当番号のカードを表示します。
    - **機材操作 (`.`)**: テンキーの「.」を押すと、即座にダイスを振ります。
    - **SPマーカー操作 (`O`)**: キャッシュに残さない強制非表示/表示のトグル。配信の演出上、一時的にマーカーを消したい場合に使用します。
- **マウス操作**:
    - **ダブルクリック**: カードリスト上のカード、または詳細ビューの拡大画像をダブルクリックすることで、即座にピン留め/解除をトグルできます。
- **オーバーレイ連携**: 選択されたカードは即座にオーバーレイ窓へ送信され、拡大表示されます。
    - **表示モード (Display Mode)**: コントローラーから「画像モード」と「テキストモード」を切り替え可能です。
        - **テキストモード**: カード名、HP/LIFE、属性（色）、スキル、アーツ、バトンタッチ、キーワード能力、注釈テキストを構造化して表示します。
            - サポートカード（アイテム、イベント等）は、「サポート・」を取り除いた**カテゴリ名のみ**を種別欄に表示します。
            - **LIMITEDカード**の表記は種別欄から削除し、カード最下部の注記セクションに「**LIMITED: ターンに1枚しかつかえない**」と表示されます。
            - **カード名**: 視認性とデザイン性を高めるため、**常に白文字**で固定されます。
            - **ヘッダーレイアウト**: 最上部の行は、属性情報（色・レベル）を左側に、ステータス（HP）を右側に寄せる機能的な配置を採用しています。
                - **左側**: [**タイプアイコン**] [**カードタイプ/レベル** (Debut/1st等)]
                - **右側**: [**HP / ❤ 数値**]
            - **タイプアイコン**:
                - ホロメンおよび推しホロメンカードにおいて、カードの色に応じた公式スタイルのアイコン（`type_***.png`）を表示します。
                - 単色だけでなく、多色カード（「青赤」など）の場合も対応する連結アイコンを動的に表示します。
            - **バトンタッチ**: ホロメンおよびBuzzホロメンカードでは常に項目を表示します。
                - コストがある場合は、対応する色のカラーアイコン（エネルギーアイコン）を表示します。
                - 公式サイトでコストアイコンがない（コスト0）場合、アイコンを表示せず「バトンタッチ」テキストのみを表示し、情報の網羅性を担保します。
            - **アーツ**: コスト表示には、対応する色のエネルギーアイコン（`arts_***.png`）が並べて表示されます。
            - 推しスキルのコストは「**ホロパワー**」として表記されます。
            - **属性（色）の判定**: 内部的には `includes` を使用し、多色カードやデータのゆれを許容してアイコンイメージを動的に解決します。
            - 緑色属性は Emerald Green を採用し、OBSのクロマキー環境での視認性を確保しています。
        - **窓間同期**: 表示モードの状態（画像/テキスト）は、`BroadcastChannel` を通じてコントローラーとオーバーレイ窓で完全に同期されます。位置や回転の調整はオーバーレイ窓上の共通ハンドル（OverlayWidget）を使用して行います。
    - **機材表示レイアウト**: オーバーレイ時、カード画像の上にサイコロが表示されます。
    - **カードの独立化 (CardWidget)**: カード表示機能は、ゲームツール（ダイス等）から独立したコンボポーネントに分離されました。これにより、個別に位置・回転・スケールの調整が可能です。
    - **ガイダンス表示**: 表示対象のカードが未選択の場合や、指定されたピン留め番号が存在しない場合、設定画面への誘導手順をウィジェット内に表示します。
    - **ダイス配置の最適化**: 3Dサイコロがカードの情報を極力遮らないよう、カードの縁（上端または下端）に完全に密着した配置が行われます。
        - 内部的にネガティブマージンを適用し、コンテナのパディングを無視して枠の境界まで寄せることで、カード画像やテキストとの重複を最小限に抑えています。
        - 視認性向上のため、サイコロの背景には薄い半透明パネルが配置されます。
    - **OBS最適化描画**: 
        - **角丸とエッジ**: オーバーレイのカード枠は `24px` (rounded-3xl) の角丸を持ちます。
        - **インライン・マージン**: テキスト表示モード時、環境に依存せず確実に余白を確保するため、**インラインスタイル (`style={{ padding: '24px' }}`)** が適用されます。これにより、枠線とテキストの間に視覚的に安定した空間を提供します。
        - **背景の不透明化**: OBSでのクロマキー（グリーンバック）使用時でもカード内容やウィジェット領域が透けないよう、枠内は常に不透明な暗色（画像あり時は `#111827`, 画像なし時はより黒に近い灰色 `#1a1b23`）で描画されます。
    - **機材表示制限**: コインの表示がオフの設定では、オーバーレイ窓（カード表示オフ時含む）およびコントローラー側ではコインの表示が抑制されます。
- **SP推しスキルマーカー**:
    - **表示モード**: 「OFF」「追従（follow）」「独立（independent）」から選択可能。
    - **オーバーレイ連動解除**: メインの「オーバーレイ表示」がOFFであっても、SPマーカーの設定が有効であれば、マーカーのみが画面に残り続けます（カードを隠してSP状態だけ見せたい運用に対応）。
    - **追従モードのレイアウト**: カードの下端に配置されます。カード非表示時は、ダイスとの適切な間隔を保つため仮想的な枠組みが維持されます。
    - **非永続トグル**: `O` キーによる非表示状態は、オーバーレイの再起動やモード変更時に自動的にリセットされます。

## 6. ZIPファイル展開サポート (ZIP File Support)

配布されたカードテンプレート等のZIPファイルを、アプリ内で直接展開して利用することができます。

### 展開プロセス
- **高速化と検出**: ZIPファイルがドラッグ＆ドロップまたはメニューから読み込まれると、即座に確認モーダルを表示します。
    - **解析のスキップ**: ユーザーの待機時間を最小限にするため、展開前の全ファイル走査（カウント）は行わず、即座に展開先選択へ進むことができます。
    - **ディレクトリ階層の最適化**: 展開プロセス中に、ZIP内の全ファイルが単一のルートフォルダに格納されているかを判定し、冗長なトップフォルダがある場合は自動的にスキップして中身だけを抽出します。
- **展開先の自動管理**: ユーザーが選択した「展開先フォルダ」の直下に、**ZIPファイル名（拡張子なし）に基づいた新しいフォルダ**を自動作成し、そこへ展開します。
- **自動接続**: 展開が完了すると、新しく作成されたフォルダが自動的にアプリケーションのルートディレクトリとして設定され、即座にスキャンと同期が開始されます。

### 操作ロックと安全装置 (Action Lock)
ZIP展開中は、不完全な状態での操作によるエラーや競合を防ぐため、システム全体に**操作ロック**がかかります。
- **UIオーバーレイ**: 「展開中...」のステータスと進捗を示す専用のオーバーレイが表示されます。
- **入力の遮断**: 展開が完了または中断されるまで、以下の操作が完全に無効化されます。
    - **キーボードショートカット**: すべてのキー入力が無視されます。
    - **メニュー操作**: 右クリックによる設定メニューの表示がブロックされます。
    - **矩形選択 (Selecto)**: マウスドラッグによるウィジェットの複数選択操作がブロックされます。
- **中断 (Cancel) 機能**: オーバーレイ上の「キャンセルして削除」ボタンから、展開をいつでも安全に中止できます。

### 失敗時のクリーンアップ
- **中断時の自動削除**: ユーザーが展開をキャンセルした場合、作成途中のフォルダおよびファイルはすべて自動的に削除され、システムを清潔に保ちます。
- **エラー時の処理**: 展開中にバリデーションエラー（空のアーカイブ等）や書き込みエラーが発生した場合、作成された不完全なフォルダを削除するかどうかの確認ダイアログが表示されます。

### 堅牢なファイル処理
特にWindows環境における互換性と安全性を高めるため、以下の処理を各ファイル操作時に適用しています。
- **パスの正規化**: Windows形式のバックスラッシュ (`\`) を標準的なスラッシュ (`/`) に統一して処理します。
- **ファイル名サニタイズ**: OSで禁止されている予約文字 (`< > : " / \ | ? *`) をアンダースコア (`_`) に置換し、さらに `.` (ドットのみ) などの不適切なパス要素をフィルタリングして除外します。
- **多重実行防止**: 展開中に重複した要求が発生しないよう、状態ガード (`useRef`) を用いて直列化されています。
