# Walkthrough: メタデータと検索エンジンの実装・改善

このドキュメントでは、ローカルカードの読み込みロジック改善機能と検索エンジンの強化について、何が実装され、どのように動作するのかをまとめます。

## 追加された機能・変更点

### 1. アプリ内同梱画像データ（ホロライブ公式）の削除
- 設計書の「空のキャンバス」構想に従い、アプリに組み込まれていた `hololive-cards.json` の読み込みをインポートから完全に削除しました。
- アプリを起動した当初はカードが1枚も表示されないクリーンな状態となり、ユーザーが指定したローカルフォルダの画像のみが検索・リストアップの対象になります。

### 2. メタデータの解析と優先順位付け (`metadata.json`)
- `useLocalCards` フックにて、ローカルフォルダ内の画像をスキャンすると共に、各階層にある `metadata.json` をパースします。
- メタデータは上位フォルダから下位のサブフォルダへと順に読み込まれるため、サブフォルダ内の設定が優先されます（オーバーライド可能）。
- 拡張子抜き（`card`）や完全一致（`card.png`）での柔軟な紐付けに対応しています。ファイル名だけのマッチによるフォールバックも追加されています。

### 3. 同名ファイルの独立化と共有設定 (`mergeSameNameCards`)
- 同名ファイル (例: `deckA/token.png` と `deckB/token.png`) は**デフォルトで全て独立した個別のカード**として扱われます（パスベースの固定ID管理）。
- **結合オプション**: UIの「設定（Settings）」>「ウィジェット（ローカルカード画像の読み込み）」内に、「同名ファイルの結合 (階層順)」のトグル設定を追加しました。
  - **設定オンの場合**：同名画像は1つのカードとして重複排除され、より浅い階層（ルートに近い方）の実体ファイルが採用されます。
- ただし、メタデータ内に `"standalone": true`, `"別カード扱い": true`, `"separateCard": true` などのフラグがある場合は、この全体設定がオンであっても、強制的に独立したカードとして読み込まれます。

### 4. 検索エンジンの強化とローカル統合
- 全てのカードは `useCardSearch.ts` 経由で統合管理され、メタデータに含まれるフィールドがそのまま検索対象にマッピングされます。
- ワイルドカード (`*`) を用いた正規表現ベースの検索に対応しました（例: `*ドラ*` で、間に任意の文字を含むカードを検索可能）。
- `metadata.json` 内の `yomi`（読み仮名）を標準的にひらがな・カタカナ・記号除去の各パターンに変換し、直感的なかな検索をサポートします。

### 5. 動的なフィルタリング UI (`FilterPanel`)
- 読み込まれたローカルカード群の実データ（色、カードタイプ、ブルームレベルなど）を走査して、フィルタパネルの選択肢が**動的に生成**されるようになりました。
- 独自のカードタイプ（例: `オリジナル`、`スペルカード`など）が追加されても、フィルタボタンのカテゴリとして自動追加・描画されます。

## 検証プラン

以下の手順で新規機能が期待通りに動作するかを確認してください。

- [x] **空のキャンバスとしての動作**: ブラウザで開いた際、初期から存在する公式カードが表示されない（ローカルスキャン前は空白）こと。
- [x] **同名ファイル分離の動作（デフォルト）**: `deckA/token.png` と `deckB/token.png` などの同名ファイルが用意されている場合、設定オフ状態では検索結果やリストに個別のカードとして並ぶこと。
- [x] **結合オプションの動作**: 「設定 > ウィジェット > 同名ファイルの結合」をオンにした瞬間に再スキャンが自動で走り、同名ファイルが1つにまとまる（画像はより上位階層のものが使われる）こと。
- [x] **検索とフィルタ**: `yomi` やワイルドカードによる高度な検索・および手持ちカードに基づいたフィルタボタンの動的生成が正しく機能すること。
