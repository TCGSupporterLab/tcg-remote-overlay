# TCG Remote Overlay 次世代アーキテクチャ設計書 (Draft)

## 1. 基本コンセプト
- **「空のキャンバス」**: 初期状態は何もないオーバーレイ。ユーザー自身がローカルから画像アセットを設定することで、任意のTCG環境を構築する。
- **著作権フリー設計**: 特定のTCGのカード画像をアプリ内に同梱せず、全てユーザーのローカルフォルダから読み込む。
- **シングルウィンドウUI**: これまでの「操作窓（コントローラー）と表示窓（オーバーレイ）の分離」を撤廃。フルスクリーンのオーバーレイ画面一本に統合し、設定メニューを前面に重ねて操作する。

## 2. 画面とUIの動作
- **初期状態（データ未設定時）**: アプリ名、簡単な説明、操作方法、免責事項、開発応援用リンク（Amazonほしいものリスト）のみを表示するクリーンな画面。
- **設定メニュー**:
  - **起動ショートカット**: `Esc` キー または 右クリック。
  - **配置と構造**: オーバーレイ画面に被さるように表示。一番上にアプリ名、続いて各種設定項目があり、一番下に免責事項や応援リンクを配置する。
  - **シングルウィンドウUI（ハイブリッド）**: 
  - 基本的にはフルスクリーンのオーバーレイ画面一本に統合し、設定メニューを前面に重ねて操作する。
  - **検索・選択画面の分離**: カードの検索やピン留め操作などの広い領域を必要とする機能については、ユーザーの選択により「別タブ」または「別ウィンドウ（サブモニター用など）」として分離して起動できる。
  - **状態同期**: BroadcastChannel API を使用し、どのウィンドウで操作してもリアルタイムに全ての画面（メインオーバーレイ、検索画面、ピン留めされたカード等）の状態が同期される。
  - ※ 元の「起動」「別窓で起動」は一本化により完全廃止。

## 3. ウィジェット・システム
- 従来の「遊戯王モード」「ホロライブモード」の固定画面を廃止し、独立したウィジェット群とする。
- 設定メニューからそれぞれの表示/非表示を個別にトグルできる。
  - **共通ウィジェット**: 3Dダイス、3Dコイン、カード画像表示
  - **OCG専用ウィジェット**: 遊戯王用（ライフポイント計算機）、ホロライブ用（SP推しスキルマーカー）
- **結合機能**: ウィジェット同士を組み合わせる仕組みを用意。
  - 実装方針: ドラッグ＆ドロップ時に一定距離に近づいたウィジェット同士をスナップさせることで「重ねた結合」と「距離を開けた結合」の両方をサポートする。
  - **テンプレート機能**: ユーザーが構築したウィジェット群の配置（相対座標や結合状態）は JSON として保存・共有でき、呼び出すことが可能。
  - デフォルトのテンプレートとして、現在の「遊戯王モード」「ホロライブモード」の画面構成に相当するウィジェット群の設定を初期データとして登録しておく。

## 4. カード管理・検索エンジン（ローカルフォルダ連携）
- **ファイル読み込み (File System Access API)**:
  - ユーザーが指定したローカルフォルダから画像（`.png`, `.jpeg` 等）を直接読み込む。
  - 再リロード時には再スキャンのみで復帰できるようアクセス権を保存する。
- **ディレクトリ構造とパース**:
  - ルートフォルダを起点とし、直下のサブフォルダ（例: OCG名）、さらにその直下のサブフォルダ（例: デッキ・パック名）までを認識する（合計 階層0, 1, 2層目の画像までを探索）。
  - サブフォルダは「フォルダアイコン」として表示し、中に画像がない場合は非表示。画像と混在している場合は「フォルダ優先 → 画像」の順で並べる。
- **カードの同一判定**:
  - デフォルト: 同名ファイルでも別カードとして扱う（パスで区別）。
  - 設定時: 同名ファイルを「同じカード」として扱うオプションを用意。その場合、「1. ルートフォルダ内のファイル」「2. サブフォルダのうちフォルダ名昇順で一番上のもの」の順に優先採用する。
- **画像の視覚的変形**:
  - 画像のアスペクト比と角丸（border-radius）を自由に調整可能な「高度な設定」を用意。
  - デフォルトは現行のホロライブカードのサイズ基準合わせる。
- **検索ロジック**:
  - **対象**: `フォルダ名`、`ファイル名`、および `フォルダ名\ファイル名`。
  - ワイルドカード（`*`）による前方・後方・中間一致検索＋結果のカード名ソート。

## 5. メタデータ登録（高度な検索機能）
- 各フォルダ内に `metadata.json` を配置することで、カードのメタデータ（ATK, DEF, 色など）や読み仮名を登録できる。
- **配置・パースルール**:
  - ルートフォルダ直下の json: `"OCG名\デッキ名\ファイル名.拡張子": { ... }` などの全体の統合設定。
  - 1層目（OCG名等）直下の json: `"デッキ名\ファイル名.拡張子": { ... }` などのOCG全体の設定。
  - 2層目（デッキ等）直下の json: `"ファイル名.拡張子": { ... }` などの個別パック・デッキの設定。
  - **優先度**: より深い階層（個別配置）にある json の設定を優先する（上書き）。
  - キーのマッチング優先度: 1. 拡張子までの完全一致, 2. 拡張子なしでの一致。
- **カスタムタブとフィルタリング**:
  - メタデータのキー（例外: `yomi`）から自動的に検索UIの「タブ」が生成される（現在のタイプやBloomなどのイメージ）。
  - タブ内の値でソート・フィルタリングが可能（現在はすべて一括文字列としてソート比較）。メタデータを持たない画像はフィルタにHITしない。
- **読み検索 (`yomi`)**:
  - キーに `"yomi": "あいう"` のように指定すると、タブには表示されないが検索バーでの読みがな検索にヒットする。

## 6. ビデオ設定と画面レイヤー（Z-Index）の構成
- 次の順序で背面から前面へ順番にレイヤーを重ねる構成とする。
  1. ビデオ映像（最背面）
  2. GB（クロマキー合成等用背景色）
  3. 各種ウィジェット群（ダイス、カード画像、ライフ計算機など）
  4. ビデオ表示調整画面（ホイールクリック等で呼び出す個別の画角調整UI）
  5. 設定メニュー（最前面）
- 従来の機能（ビデオソース切り替え、ビデオ表示調整、GB設定）の呼び出し口自体は「設定メニュー」内の項目として統合する。
## 7. 画面表示の制御ロジック
- **URLパラメータによる制御**: 
  - `?mode=overlay`: オーバーレイ表示専用モード。
  - `?view=search`: 検索・選択画面専用モード。設定メニューやビデオ背景を隠し、検索UIのみを全画面表示する。
- 状態の永続化には `localStorage` を使用し、ウィンドウ間の即時反映には `BroadcastChannel` を使用する。

## 8. キーボードショートカット
- 基本的に現状のキーバインド（0-9, +, -, D, C, V, M など）を踏襲する。
- 統合により遊戯王・ホロライブ間で衝突するキーがあるため、開発過程で適切な競合調整を実施する。
