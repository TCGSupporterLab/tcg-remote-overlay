# マイレイアウト機能の実装計画

ウィジェットの配置、回転、拡大率、表示状態、グループ化、および重なり順を一括して保存・復元・共有できる「マイレイアウト」機能を実装します。

## ユーザーレビュー要求事項

> [!IMPORTANT]
> - 「表示プリセット」という用語を廃止し、「マイレイアウト」に統一します。
> - 遊戯王・ホロライブの初期構成も「削除可能な一つのレイアウト」として扱います。
> - **追加オプション**: レイアウト復元時に「レイアウトに含まれないウィジェットを非表示にするか」をユーザーが選択できるようにします。
> - ウィンドウサイズ（アスペクト比）の変更に対する座標補正の精度については、正規化座標（px, py）をベースに実装しますが、完全に同一の見た目を保証できない場合があります。

## 修正内容の概要

### 1. データ構造の定義
`MyLayout` は、**保存時に選択されていたウィジェットの集合**を記録します。これにより、単一ウィジェット、結合ウィジェット、またはそれらの混在を柔軟に保存できます。

```typescript
export interface MyLayout {
    id: string;
    name: string;
    // 保存対象のウィジェットIDとそれぞれの個別状態
    widgets: {
        id: WidgetId;
        state: WidgetState;
    }[];
    // 保存対象のウィジェット間で形成されていたグループ情報
    groups: WidgetGroup[];
    // 表示管理、順序、メタデータ
    visibility: Record<WidgetId, boolean>; // 対象ウィジェットの表示状態
    widgetOrder: WidgetId[];              // 対象ウィジェット間の相対的な重なり順
    viewSize: { w: number; h: number };   // 保存時のウィンドウサイズ
    createdAt: number;
}
```

### 2. ストアの拡張
`src/store/useWidgetStore.ts` に以下のアクションを追加します。

- `saveLayout(name: string)`: 
    - 現在選択されているウィジェット（`selectedWidgetIds`）を抽出。
    - 抽出されたウィジェットに関わる `widgetStates`, `widgetOrder` を取得。
    - **グループの扱い**: 選択されたウィジェットが所属するグループのうち、メンバー全員が選択範囲内にあるグループを `groups` として保存。
- `applyLayout(layout: MyLayout)`: 
    - 1. レイアウトに含まれるウィジェットについて、既存のグループ結合を強制解除。
    - 2. ウィジェットを表示ONにする。
    - 3. `widgetStates` を復元。
    - 4. レイアウトに含まれる `groups` 定義を現在の `groupData` に追加（マージ）。
    - 5. `widgetOrder` を反映（全体の中での相対位置を維持）。
- `deleteLayout(id: string)`: キャッシュから削除。
- `importLayout(data: unknown)`: 
    - **バリデーション**: 入力データが `MyLayout` 型の構造と一致するか厳密にチェック。
    - **サニタイズ**: レイアウト名等の文字列から不正なコードを排除。
    - 不正なデータの場合はエラーを表示し、取り込みを中断。

### 3. アクションバー (SelectionActionBar)
- 一番左に「マイレイアウトに追加」ボタンを追加。
- クリック時に `window.prompt` または簡易的なモーダルを表示して名称を入力。

### 4. 設定メニュー (SettingsMenu)
- 「マイレイアウト」タブを新規作成。
- **グローバル設定**:
    - 「復元時に他のウィジェットを非表示にする」トグルボタン。
- レイアウトの一覧表示：
    - 「復元」ボタン：配置を適用。
    - 「エクスポート」ボタン：JSONファイルとしてダウンロード。
    - 「削除」ボタン：確認後、キャッシュから削除。
- 「インポート」ボタン：JSONファイルを読み込み。

### 5. セキュリティとバリデーション
外部ファイル（JSON）のインポート時に以下の対策を講じます。

- **構造チェック**: schema定義に基づき、必要なフィールド（widgets, groups等）が存在し、型が正しいか確認。
- **値の制限**: 
    - 座標やスケールが異常な値（極端に大きい値や負の数など）でないか検証。
    - 存在しない `WidgetId` は無視。
- **エラーハンドリング**: `JSON.parse` およびバリデーション失敗時にアプリがクラッシュしないよう `try-catch` で保護し、ユーザーに通知。

### 6. 初期ロード処理
- キャッシュが空の場合、プロジェクト内のデフォルト設定（遊戯王、ホロライブ）を読み込み、一度だけキャッシュに展開します。

---

## 検証計画

### 手動確認
1.  **保存・復元テスト**
    - 適当にウィジェットを配置・回転させ、「マイレイアウトに追加」を実行。
    - 別の配置にした後、設定メニューから「復元」を押し、元の状態に戻ることを確認。
2.  **グループ化の復元**
    - 結合されたウィジェットを含むレイアウトを保存。
    - 一旦バラバラにした後、復元して再度正しく結合されることを確認。
3.  **表示状態の連動**
    - 非表示にしたウィジェットを含むレイアウトを復元した際、自動的に表示がONになることを確認。
4.  **共有テスト**
    - エクスポートしたJSONを一旦削除し、再度インポートして正常にリストに現れることを確認。
5.  **デフォルトロード**
    - `localStorage` をクリアした状態で起動し、遊戯王とホロライブのレイアウトが最初から存在することを確認。
