# 修正内容の確認 (Walkthrough): カードウィジェットの状態維持とD&Dの修正

## 実施した変更

### 1. フォルダキャッシュ復順ロジックの修正
- `src/App.tsx` において、`rootFolderName` が変更された際の処理を見直しました。
- 以前は「未接続状態から接続された場合 (`wasEmpty`)」のみキャッシュを復元していましたが、この条件を削除し、フォルダ名が変更された場合は常に新しいフォルダのキャッシュを復元するようにしました。
- これにより、D&D で別のフォルダを読み込んだ際に、そのフォルダ用のピン留めカードなどが正しく読み込まれるようになります。

### 2. ピン留め情報の自動リフレッシュ機能の強化
- `src/hooks/useCardSearch.ts` の `useEffect` (永続データの再同期) の依存配列に `sharedState.pinnedCards` を追加しました。
- これにより、キャッシュから古い（Blob URL が無効な）カードデータが読み込まれた直後に、現在のカードスキャン結果と照合して URL を最新化する処理が確実に実行されるようになります。
- 「モードを切り替えるとピン留め表示が消える（または画像がリンク切れになる）」問題がこれで解消されます。

### 3. カードウィジェットの動作安定化
- フォルダスキャン時や接続再開時のステート同期をより確実にし、ユーザーが迷わずにセットアップを完了できる案内（ガイダンス）が適切なタイミングで表示されるようにしました。

## 確認方法
1. **ライブラリモードでピン留め**: フォルダを接続し、いくつかのカードをピン留めします。
2. **シンプルモードへの切り替え**: 画像ファイルをウィジェットに D&D するか、設定から「シンプル」に切り替えます。
3. **ライブラリモードへの復帰**: 設定から「ライブラリ」に戻します。
   - ピン留めカードが消えずに、正しい画像で表示されることを確認してください。
4. **フォルダの切り替え**: 別のカード画像が含まれるフォルダを D&D します。
   - 以前そのフォルダを使っていた場合、その時のピン留め内容が復元されることを確認してください。
5. **リロード**: 画面をリロードし、アクセス許可を与えた後に、ピン留めカードが正しく表示されることを確認してください。
